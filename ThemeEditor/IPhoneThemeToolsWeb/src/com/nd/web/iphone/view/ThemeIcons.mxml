<?xml version="1.0" encoding="utf-8"?>
<mx:ViewStack xmlns:mx="http://www.adobe.com/2006/mxml"
			  xmlns:ndView="com.nd.web.iphone.view.*"
			  xmlns:viewStackEffects="org.efflex.mx.viewStackEffects.*"
			  width="550"
			  height="700"
			  borderStyle="solid"
			  cornerRadius="10"
			  borderColor="#000000"
			  fontSize="12"
			  alpha="1"
			  creationComplete="init();">
	<mx:Script>
		<![CDATA[
			import mx.graphics.codec.JPEGEncoder;
			import mx.core.UIComponent;
			import mx.core.Application;
			import com.nd.web.iphone.vo.ThemeVo;
			import mx.events.CloseEvent;
			import mx.controls.Alert;
			import com.nd.web.iphone.event.GenerateThemeEvent;
			import com.adobe.cairngorm.control.CairngormEventDispatcher;
			import com.nd.web.iphone.event.GetIconsEvent;
			import com.nd.web.iphone.vo.IconVo;
			import com.nd.web.iphone.model.ThemeModelLocator;
			import com.nd.web.iphone.util.Color;
			private var lastClickCav:Canvas=null;
			[Bindable]
			private var model:ThemeModelLocator=ThemeModelLocator.getInstance();

			/**
			 * 初始化容器边框和背景
			 */
			private function init():void
			{
				drawMask(appCav, Color.BLACK);
				drawMask(wallpaperCav, Color.BLACK);
				drawMask(statusCav, Color.BLACK);
				drawMask(dockCav, Color.BLACK);
				drawMask(themInfoCav, Color.BLACK);
			}

			/**
			 * 绘制边框和标题背景填充
			 */
			public function drawMask(drawCav:Sprite, color:uint):void
			{
				//画cav边框
				drawCav.graphics.clear();
				drawCav.graphics.lineStyle(1, color, 1, true);
				drawCav.graphics.drawRoundRect(0, 0, drawCav.width, drawCav.height, 20, 20);
				//填充圆角矩形
				drawCav.graphics.beginFill(color);
				drawCav.graphics.drawRoundRect(1, 1, 29, (drawCav.height - 1), 20, 20);
				//直译矩形，使之成为半边矩形
				drawCav.graphics.beginFill(color);
				drawCav.graphics.drawRect(11, 1, 19, (drawCav.height - 1));
				drawCav.graphics.endFill();
			}

			/**
			 * 容器点击事件处理，高亮显示
			 */
			public function highlightHandler(drawCav:Canvas):void
			{
				if (lastClickCav != null)
				{
					drawMask(lastClickCav, Color.BLACK);
				}
				drawMask(drawCav, Color.RED);
				lastClickCav=drawCav;
			}

			/**
			 * 进入图标修改模式
			 */
			public function gotoEditMode(editIcon:IconVo):void
			{
				this.selectedIndex=1;
				if (model.curEditIcon != null && model.curEditIcon.name != editIcon.name)
				{
					model.curEditIcon=editIcon;
					if (model.curToolbarIndex != 0)
					{
						iconDesignerView.gotoOnlineTheme();
					}
				}
				model.curEditIcon=editIcon;
				iconDesignerView.changeEditPicture();
			}

			/**
			 * 保存主题
			 */
			public function saveTheme():void
			{
				if (themeNameText.text == '')
				{
					model.curThemeGenerateStatus=-1;
					model.curThemeGenerateInfo='主题保存失败！主题名称不能为空，请输入主题名称。';
					model.isCurThemeInfoVisible=true;
					return;
				}
				else if (authorNameText.text == '')
				{
					model.curThemeGenerateStatus=-1;
					model.curThemeGenerateInfo='主题保存失败！作者名称不能为空，请输入作者名称。';
					model.isCurThemeInfoVisible=true;
					return;
				}
				else if (themeTypeCB.selectedIndex == -1)
				{
					model.curThemeGenerateStatus=-1;
					model.curThemeGenerateInfo='主题保存失败！主题分类不能为空，请输入主题分类。';
					model.isCurThemeInfoVisible=true;
					return;
				}
				model.themInfoCavSelectedIndex=1;
				model.curThemeName=themeNameText.text;
				model.curThemeAuthorName=authorNameText.text;
				model.curThemeThemeTypeId=themeTypeCB.selectedItem.c_id;
				//1提交审核，0草稿
				model.curThemeIsPublish=(themePublishCB.selected ? 1 : 0);
				model.curIphoneScreenShot=getByteArray(getBitmapData(Application.application.iphoneView.screenCav));
				CairngormEventDispatcher.getInstance().dispatchEvent(new GenerateThemeEvent());
			}

			//截图功能函数
			private function getBitmapData(target:UIComponent):BitmapData
			{
				var bd:BitmapData=new BitmapData(target.width, target.height);
				var m:Matrix=new Matrix();
				bd.draw(target, m);
				return bd;
			}

			private function getByteArray(data:BitmapData):ByteArray
			{
				var pngEnconder:JPEGEncoder=new JPEGEncoder();
				var bytes:ByteArray=pngEnconder.encode(data);
				return bytes;
			}


			/**
			 * 下载iphone主题
			 */
			private function downloadIphoneTheme():void
			{
				navigateToURL(new URLRequest(model.curThemeDownloadUrl), "_blank");
			}

			/**确认图标是否重置*/
			private function confirmResetIcon():void
			{
				var text:String='您是否已完成当前主题制作并且保存，确定新建主题？';
				var title:String='提示信息';
				Alert.yesLabel='新建';
				Alert.cancelLabel='取消';
				Alert.buttonWidth=70;
				var alert:Alert=new Alert();
				alert=Alert.show(text, title, Alert.YES | Alert.CANCEL);
				alert.addEventListener(CloseEvent.CLOSE, newTheme);
			}

			/**
			 * 新建主题
			 */
			private function newTheme(evt:CloseEvent):void
			{
				switch (evt.detail)
				{
					case Alert.CANCEL:
						break;
					case Alert.YES:
					{
						model.curTheme=new ThemeVo();
						model.curTheme.fillDefault(model);
						model.curThemeId=-1;
						model.curThemeName='';
						model.curThemeAuthorName='';
						model.isCurThemeInfoVisible=false;
						break;
					}
				}
			}
		]]>
	</mx:Script>
	<viewStackEffects:List id="effect"/>
	<mx:Canvas width="100%"
			   height="100%"
			   hideEffect="effect"
			   showEffect="effect">
		<!--应用图标区域-->
		<mx:Canvas id='appCav'
				   x="10"
				   y="10"
				   width="528"
				   height="101">
			<mx:Text x="0"
					 y="0"
					 text="应用图标"
					 height="101"
					 width="29"
					 paddingTop="0"
					 fontSize="18"
					 color="#FFFFFF"
					 fontWeight="bold"
					 textAlign="center"/>
			<mx:Text x="48"
					 y="75"
					 text="单击左侧应用图标，进行应用图标替换修改"
					 width="274"
					 height="26"
					 fontWeight="bold"
					 color="{Color.GREEN}"/>
			<mx:Label x="48"
					  y="5"
					  text="标准尺寸： 48 * 48"
					  width="159"/>
			<mx:Label x="48"
					  y="30"
					  text="图片大小：小于10K"
					  width="188"/>
			<mx:Label x="48"
					  y="55"
					  text="支持格式： png 或 jpg"
					  width="168"/>
		</mx:Canvas>
		<!-- 壁纸区域-->
		<mx:Canvas id='wallpaperCav'
				   x="10"
				   y="119"
				   width="528"
				   height="198">
			<mx:Text x="0"
					 y="0"
					 text="桌面壁纸"
					 height="196"
					 width="29"
					 paddingTop="50"
					 fontSize="18"
					 color="#FFFFFF"
					 fontWeight="bold"
					 textAlign="center"/>
			<mx:Image x="102"
					  y="10"
					  width="120"
					  height="180"
					  toolTip="点击替换壁纸"
					  source="{model.curTheme.wallpaper.sourceBmd}"
					  buttonMode="true"
					  useHandCursor="true"
					  click="gotoEditMode(model.curTheme.wallpaper);"/>
			<mx:Label x="244"
					  y="18"
					  text="标准尺寸： 320 * 480"
					  width="159"/>
			<mx:Label x="244"
					  y="46"
					  text="图片大小：小于200K（避免影响性能）"
					  width="228"/>
			<mx:Label x="244"
					  y="74"
					  text="支持格式： png 或 jpg"
					  width="228"/>
			<mx:LinkButton x="244"
						   y="102"
						   width="188"
						   icon="{model.assets.addIcon}"
						   label="进行壁纸替换修改"
						   textAlign="left"
						   color="{Color.GREEN}"
						   paddingLeft="0"
						   click="gotoEditMode(model.curTheme.wallpaper);"/>
		</mx:Canvas>
		<!-- 状态栏区域-->
		<mx:Canvas id='statusCav'
				   x="10"
				   y="325"
				   width="528"
				   height="80">
			<mx:Text x="0"
					 y="0"
					 text="状态栏"
					 height="78"
					 width="29"
					 paddingTop="2"
					 fontSize="18"
					 color="#FFFFFF"
					 fontWeight="bold"
					 textAlign="center"/>
			<mx:Image x="44"
					  y="10"
					  height="20"
					  width="320"
					  source="{model.curTheme.statusBar.sourceBmd}"
					  toolTip="点击替换状态栏"
					  buttonMode="true"
					  useHandCursor="true"
					  click="gotoEditMode(model.curTheme.statusBar);"/>
			<mx:Label x="44"
					  y="38"
					  text="标准尺寸： 320 * 480"
					  width="144"/>
			<mx:Label x="44"
					  y="60"
					  text="图片大小：小于10K(避免影响性能)"
					  width="274"/>
			<mx:Label x="205"
					  y="38"
					  text="支持格式： png 或 jpg"
					  width="159"/>
			<mx:LinkButton x="372"
						   y="50"
						   width="156"
						   icon="{model.assets.addIcon}"
						   label="进行状态栏替换修改"
						   textAlign="left"
						   color="{Color.GREEN}"
						   paddingLeft="0"
						   height="20"
						   click="gotoEditMode(model.curTheme.statusBar);"/>
		</mx:Canvas>
		<!-- dock 区域-->
		<mx:Canvas id='dockCav'
				   x="10"
				   y="413"
				   width="528"
				   height="111">
			<mx:Text x="0"
					 y="0"
					 text="DOCK"
					 height="111"
					 width="25"
					 paddingLeft="5"
					 fontSize="18"
					 color="#FFFFFF"
					 fontWeight="bold"
					 textAlign="center"
					 paddingTop="5"/>
			<mx:Image x="44"
					  y="10"
					  width="320"
					  height="91"
					  toolTip="点击替换Dock"
					  source="{model.curTheme.dock.sourceBmd}"
					  buttonMode="true"
					  useHandCursor="true"
					  click="gotoEditMode(model.curTheme.dock);"/>
			<mx:Label x="372"
					  y="10"
					  text="标准尺寸： 320 * 480"
					  width="144"/>
			<mx:Label x="372"
					  y="35"
					  text="支持格式： png 或 jpg"
					  width="149"/>
			<mx:Label x="372"
					  y="60"
					  text="图片大小： 小于30K"
					  width="146"/>
			<mx:LinkButton x="372"
						   y="85"
						   width="150"
						   icon="{model.assets.addIcon}"
						   label="进行DOCK替换修改"
						   textAlign="left"
						   color="{Color.GREEN}"
						   paddingLeft="0"
						   height="20"
						   click="gotoEditMode(model.curTheme.dock);"/>
		</mx:Canvas>
		<!--主题信息，处理区域-->
		<mx:ViewStack id="themInfoCav"
					  x="10"
					  y="532"
					  width="528"
					  height="156"
					  fontSize="12"
					  selectedIndex="{model.themInfoCavSelectedIndex}">
			<mx:Canvas width="100%"
					   height="100%">
				<mx:Text x="0"
						 y="0"
						 text="主题信息"
						 height="156"
						 width="25"
						 paddingTop="25"
						 fontSize="18"
						 color="#FFFFFF"
						 fontWeight="bold"
						 textAlign="center"/>
				<mx:Image height="32"
						  width="32"
						  source="{model.curThemeGenerateStatus==0?model.assets.successIcon:model.assets.failureIcon}"
						  visible="{model.isCurThemeInfoVisible}"
						  x="49.5"
						  y="5"/>
				<mx:Label text="{model.curThemeGenerateInfo}"
						  color="{Color.RED}"
						  height="25"
						  fontSize="15"
						  visible="{model.isCurThemeInfoVisible}"
						  width="408"
						  x="89.5"
						  y="10"/>
				<mx:Label x="49.5"
						  y="40"
						  text="主题名称："
						  width="75"/>
				<mx:TextInput id="themeNameText"
							  x="132.5"
							  y="40"
							  width="137"
							  text="{model.curThemeName}"/>
				<mx:Label x="287.5"
						  y="40"
						  text="作者名称："
						  width="74"/>
				<mx:TextInput id="authorNameText"
							  x="360.5"
							  y="40"
							  width="137"
							  text="{model.curThemeAuthorName}"/>
				<mx:Label x="49.5"
						  y="80"
						  text="主题分类："
						  width="75"/>
				<mx:ComboBox id="themeTypeCB"
							 x="132.5"
							 y="77"
							 width="136.5"
							 labelField="c_name"
							 dataProvider="{model.themeTypeList}"/>
				<mx:CheckBox id="themePublishCB"
							 x="287.5"
							 y="78"
							 label="提交该主题到91主题平台上审核发布"
							 width="220"
							 selected="false"/>
				<mx:HBox y="108"
						 width="468.5"
						 x="49.5"
						 height="43"
						 horizontalAlign="center"
						 horizontalGap="20">
					<mx:Button x="33"
							   y="110"
							   label="新建主题"
							   width="125"
							   height="41"
							   icon="{model.assets.newThemeIcon}"
							   buttonMode="true"
							   useHandCursor="true"
							   fontSize="14"
							   click="confirmResetIcon();"
							   visible="{model.curThemeId==-1?false:true}"/>
					<mx:Button x="201.5"
							   y="110"
							   label="保存主题"
							   width="125"
							   height="41"
							   icon="{model.assets.saveEditIcon}"
							   buttonMode="true"
							   useHandCursor="true"
							   fontSize="14"
							   click="saveTheme();"/>
					<mx:Button x="372.5"
							   y="110"
							   label="下载主题"
							   width="125"
							   height="41"
							   icon="{model.assets.downloadThemeIcon}"
							   buttonMode="true"
							   useHandCursor="true"
							   fontSize="14"
							   click="downloadIphoneTheme();"
							   visible="{model.curThemeId==-1?false:true}"/>
				</mx:HBox>
			</mx:Canvas>
			<mx:Canvas width="100%"
					   height="100%">
				<mx:Text x="0"
						 y="0"
						 text="主题信息"
						 height="119"
						 width="25"
						 paddingTop="12"
						 fontSize="18"
						 color="#FFFFFF"
						 fontWeight="bold"
						 textAlign="center"/>
				<mx:ProgressBar x="155.5"
								y="39"
								id="progressBar"
								label="正在处理中,请稍等。。。。"
								labelPlacement="center"
								indeterminate="true"
								indeterminateMoveInterval="20"
								trackHeight="64"
								height="24"
								width="235"/>
			</mx:Canvas>
		</mx:ViewStack>
	</mx:Canvas>
	<ndView:IconDesigner id="iconDesignerView"
						 hideEffect="effect"
						 showEffect="effect"/>
</mx:ViewStack>
